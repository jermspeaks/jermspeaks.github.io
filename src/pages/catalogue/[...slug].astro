---
import { getCollection } from "astro:content";
import { Image } from "astro:assets";
import CollectionDetailsPage from "../../layouts/CollectionDetailsPage.astro";
import ProseArticle from "../../components/ProseArticle.astro";
import FormattedDate from "../../components/FormattedDate.astro";
import type { CollectionEntry } from "astro:content";

export async function getStaticPaths() {
  const posts = await getCollection("catalogueBook", ({ data }) => {
    return !data.draft;
  });
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: post,
  }));
}

type Props = CollectionEntry<"catalogueBook">;

const post = Astro.props;
const { Content } = await post.render();

// Rating emoji mapping
const ratingEmojiMap: Record<number, string> = {
  6: "â¤ï¸", // Masterpiece
  5: "ðŸ¥°", // Loved
  4: "ðŸ™‚", // Liked
  3: "ðŸ˜", // Okay
  2: "ðŸ˜•", // Disliked
  1: "ðŸ™", // Hated
};

function getRatingEmoji(rating?: number | string): string {
  if (!rating) return "";
  const numRating = typeof rating === "string" ? parseInt(rating) : rating;
  return ratingEmojiMap[numRating] || "";
}

function getAuthor(): string {
  if (post.data.bookAuthor) return post.data.bookAuthor;
  if (post.data.authors && post.data.authors.length > 0) {
    return post.data.authors[0];
  }
  return "";
}
---

<CollectionDetailsPage
  section="Catalogue"
  sectionSlug="catalogue"
  title={post.data.title}
  description={post.data.description}
  image={post.data.coverImage?.src}
  imageAlt={post.data.title}
>
  <ProseArticle>
    <div
      class="grid grid-cols-3 gap-4 border-b-2 pb-2 border-solid border-gray-300 dark:border-gray-700"
    >
      {post.data.coverImage && (
        <div class="col-span-3 sm:col-span-1">
          <Image
            src={post.data.coverImage}
            alt={post.data.title}
            width={300}
            height={450}
          />
        </div>
      )}
      <div class="col-span-3 md:col-span-2">
        <div
          class="flex flex-col sm:flex-row sm:justify-between align-middle mb-2 border-b-2 border-dashed border-gray-300 dark:border-gray-700"
        >
          <div class="font-thin">
            Author: {getAuthor()}
          </div>
          {post.data.rating && (
            <div class="text-lg">
              Rating: {getRatingEmoji(post.data.rating)}
            </div>
          )}
        </div>
        {post.data.publishDate && (
          <div class="italic text-slate-600 dark:text-slate-300 mb-2">
            Published: <FormattedDate date={post.data.publishDate} />
          </div>
        )}
        {post.data.reviewDate && (
          <div class="italic text-slate-600 dark:text-slate-300 mb-2">
            Reviewed: <FormattedDate date={post.data.reviewDate} />
          </div>
        )}
        <div class="italic text-slate-600 dark:text-slate-300 mb-2">
          Added: <FormattedDate date={post.data.pubDate} />
        </div>
        {post.data.isbn && (
          <div class="italic text-slate-600 dark:text-slate-300 mb-2">
            ISBN: {post.data.isbn}
          </div>
        )}
        {post.data.description && (
          <div class="mt-2 dark:text-slate-100">{post.data.description}</div>
        )}
      </div>
    </div>
    <Content />
  </ProseArticle>
</CollectionDetailsPage>

